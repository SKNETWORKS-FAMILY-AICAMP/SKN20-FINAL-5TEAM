<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUCK DETECTIVE: THE INTERROGATION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Courier+Prime:wght@400;700&display=swap');

        :root {
            --bg-color: #1a1a1a;
            --accent-yellow: #f1c40f;
            --danger-red: #e74c3c;
            --text-white: #ecf0f1;
            --border-black: #000;
            --pixel-font: 'Press Start 2P', cursive;
            --typewriter-font: 'Courier Prime', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-white);
            font-family: var(--pixel-font);
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* === GLOBAL LAYOUT === */
        .container {
            width: 95%; max-width: 1400px; height: 90vh;
            border: 8px solid var(--border-black);
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background: #2c3e50;
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        /* === SCENE 1: INTRO (VISUAL NOVEL STYLE) === */
        #scene-intro {
            width: 100%; height: 100%;
            background: #111;
            display: flex; flex-direction: column;
            align-items: center; justify-content: flex-end; /* 캐릭터 바닥 배치 */
            position: relative;
            cursor: pointer; /* 클릭 유도 */
        }

        /* 스포트라이트 효과 */
        .spotlight {
            position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
            width: 600px; height: 100%;
            background: radial-gradient(ellipse at top, rgba(255,255,255,0.15) 0%, transparent 70%);
            pointer-events: none; z-index: 1;
        }

        /* 오리 형사 (거대 사이즈) */
        .intro-duck {
            width: 400px; height: 400px;
            z-index: 2;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.5));
            transform: translateY(50px); /* 처음에 약간 아래 */
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .intro-duck.appear { transform: translateY(0); }

        /* 인트로 대화창 (하단 고정) */
        .intro-dialog-box {
            width: 90%; height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid white;
            border-radius: 10px;
            margin-bottom: 40px;
            padding: 30px;
            z-index: 10;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,1);
        }

        .speaker-name {
            color: var(--accent-yellow);
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .intro-text {
            font-family: var(--typewriter-font);
            font-size: 1.5rem;
            line-height: 1.6;
            color: white;
            flex: 1;
        }

        .next-indicator {
            align-self: flex-end;
            color: var(--accent-yellow);
            animation: bounce 1s infinite;
            font-size: 0.8rem;
        }

        /* 시작 버튼 (인트로 끝날 때 등장) */
        .start-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--danger-red); color: white;
            border: 4px solid white; padding: 20px 40px;
            font-family: var(--pixel-font); font-size: 1.5rem;
            cursor: pointer; z-index: 20;
            box-shadow: 10px 10px 0 black;
            animation: pulse-btn 1s infinite;
        }
        .start-btn:hover { transform: translate(-50%, -55%); }

        /* === SCENE 2: MAIN GAME (기존 유지) === */
        #scene-game { display: flex; flex-direction: row; height: 100%; }

        .sidebar-left {
            width: 320px; background: #222; border-right: 6px solid var(--border-black);
            padding: 20px; display: flex; flex-direction: column; gap: 20px;
            overflow-y: auto; z-index: 20;
        }
        .case-file-folder {
            background: #e67e22; padding: 5px; border: 4px solid var(--border-black);
        }
        .case-paper {
            background: #fff; color: #000; padding: 15px;
            font-family: var(--typewriter-font); font-size: 0.85rem; line-height: 1.4;
        }

        .main-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: #2c3e50; border-bottom: 4px solid black;
        }
        .header-controls { display: flex; gap: 10px; }
        
        .btn {
            font-family: var(--pixel-font);
            background: var(--accent-yellow); color: var(--border-black);
            border: 4px solid var(--border-black); padding: 10px 20px;
            font-size: 0.8rem; cursor: pointer; text-transform: uppercase;
        }
        .btn:active { transform: translate(2px, 2px); }
        .btn.toggle-active { background: var(--danger-red); color: white; animation: pulse-btn 1s infinite; }

        .workspace { flex: 1; display: flex; position: relative; overflow: hidden; }
        .toolbox {
            width: 110px; background: #34495e; border-right: 4px solid var(--border-black);
            padding: 10px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
        }
        .tool-item {
            height: 70px; background: var(--accent-yellow); border: 4px solid var(--border-black);
            color: black; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 0.6rem; cursor: grab; user-select: none;
        }

        .canvas-zone {
            flex: 1; position: relative;
            background-image: linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px);
            background-size: 20px 20px; background-color: #2c3e50;
        }

        /* SVG Connections */
        #connection-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .connection-line { stroke: var(--accent-yellow); stroke-width: 4px; stroke-dasharray: 10, 5; }

        .placed-component {
            position: absolute; background: #3498db; color: white;
            border: 3px solid var(--border-black); padding: 8px; font-size: 0.7rem;
            cursor: move; box-shadow: 4px 4px 0 rgba(0,0,0,0.5); z-index: 10; white-space: nowrap;
        }
        .placed-component.selected { border-color: var(--accent-yellow); animation: pulse-btn 0.5s infinite; }

        /* IN-GAME INTERROGATION PANEL */
        .interrogation-panel {
            position: absolute; bottom: 0; left: 0; right: 0; height: 220px; 
            background: rgba(0,0,0,0.95); border-top: 6px solid var(--accent-yellow);
            display: flex; padding: 20px; gap: 20px; z-index: 100; 
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer;
        }
        .panel-minimized { transform: translateY(214px); }
        .interrogation-panel::before {
            content: "▲ CLICK TO SHOW DETECTIVE ▲";
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: var(--accent-yellow); color: black; padding: 5px 15px; 
            font-size: 0.7rem; font-weight: bold; border: 4px solid black; border-bottom: none; display: none; 
        }
        .panel-minimized::before { display: block; animation: bounce 1s infinite; }

        .detective-face { width: 100px; height: 100px; border: 4px solid white; background: #81ecec; flex-shrink: 0; }
        .dialog-container { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .dialog-box { flex: 1; border: 2px dashed #555; padding: 10px; color: var(--accent-yellow); font-family: var(--typewriter-font); font-size: 1.1rem; line-height: 1.5; overflow-y: auto; }
        .input-area { display: flex; gap: 10px; }
        .pixel-input { flex: 1; background: black; border: 2px solid var(--accent-yellow); color: var(--accent-yellow); padding: 5px 10px; font-family: var(--typewriter-font); font-size: 1rem;}

        /* RESULT SCREEN */
        #scene-result {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center;
        }
        .result-report {
            background: #f4f3ee; color: #1a1a1a; width: 600px; padding: 40px;
            border: 4px solid black; box-shadow: 20px 20px 0 black;
            font-family: var(--typewriter-font); position: relative;
        }
        .stamp-mark {
            position: absolute; top: 20px; right: 20px;
            border: 8px solid var(--danger-red); color: var(--danger-red);
            font-family: var(--pixel-font); font-size: 3rem; padding: 10px 20px;
            transform: rotate(-15deg) scale(2); opacity: 0; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .stamp-mark.stamped { transform: rotate(-15deg) scale(1); opacity: 1; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulse-btn { 50% { opacity: 0.8; transform: scale(0.98); } }

    </style>
</head>
<body>

<svg style="display: none;">
    <symbol id="duck-avatar" viewBox="0 0 200 200">
        <rect width="200" height="200" fill="#81ecec"/>
        <path d="M50 140 C50 100 150 100 150 140 V200 H50 Z" fill="#3498db"/>
        <rect x="50" y="180" width="100" height="15" fill="#2c3e50"/>
        <circle cx="100" cy="90" r="55" fill="#f1c40f"/>
        <path d="M40 70 L160 70 L150 40 C150 20 50 20 50 40 Z" fill="#2980b9"/>
        <rect x="40" y="65" width="120" height="10" fill="#2c3e50"/>
        <circle cx="100" cy="45" r="10" fill="#f1c40f"/>
        <ellipse cx="100" cy="110" rx="25" ry="10" fill="#e67e22"/>
        <path d="M55 85 H95 V100 H85 V105 H65 V100 H55 Z" fill="black"/>
        <path d="M105 85 H145 V100 H135 V105 H115 V100 H105 Z" fill="black"/>
        <rect x="95" y="88" width="10" height="3" fill="black"/>
        <rect x="60" y="88" width="5" height="5" fill="white" opacity="0.8"/>
        <rect x="110" y="88" width="5" height="5" fill="white" opacity="0.8"/>
    </symbol>
</svg>

<div class="container">

    <div id="scene-intro" onclick="nextIntroLine()">
        <div class="spotlight"></div>
        
        <div class="intro-duck" id="intro-duck">
            <svg width="100%" height="100%"><use href="#duck-avatar"/></svg>
        </div>

        <div class="intro-dialog-box" id="intro-box">
            <div class="speaker-name">DET. DUCK</div>
            <div class="intro-text" id="intro-text"></div>
            <div class="next-indicator">▼ Click to continue</div>
        </div>

        <button id="start-btn" class="start-btn hidden" onclick="enterGame()">취조실 입장 (ENTER)</button>
    </div>

    <div id="scene-game" class="hidden">
        
        <div class="sidebar-left">
            <div style="text-align:center; border-bottom:2px dashed #555; padding-bottom:10px;">
                <svg width="80" height="80" style="border:2px solid white; border-radius:50%;"><use href="#duck-avatar"/></svg>
                <p style="color:var(--accent-yellow); margin-top:5px; font-size:0.8rem;">DET. DUCK</p>
            </div>
            <div class="case-file-folder">
                <div class="case-paper">
                    <strong style="background:black; color:white; padding:2px;">CASE #2026-Q</strong>
                    <br><br>
                    <strong>[SITUATION]</strong><br>
                    블랙 프라이데이 트래픽 폭주로 DB 커넥션 고갈.<br><br>
                    <strong>[CONSTRAINTS]</strong>
                    <ul style="padding-left:15px; margin:5px 0;">
                        <li>L7 LB 필수 사용</li>
                        <li>Redis 캐싱 적용</li>
                        <li>DB Read/Write 분리</li>
                    </ul>
                </div>
            </div>
            <div style="margin-top:auto;">
                <button class="btn" style="width:100%; background:#e74c3c; color:white;" onclick="startDeepDive()">제출 (SUBMIT)</button>
            </div>
        </div>

        <div class="main-area">
            <div class="header-bar">
                <h2 style="margin:0; font-size:1rem;">SYSTEM ARCHITECTURE CANVAS</h2>
                <div class="header-controls">
                    <button id="btn-connect" class="btn" onclick="toggleConnectMode()">⚡ 연결 모드</button>
                    <button class="btn" onclick="showHint()">HINT</button>
                </div>
            </div>

            <div class="workspace" id="workspace">
                <div class="toolbox">
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-name="USER">USER</div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-name="L7 LB">L7 LB</div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-name="WEB SVR">WEB SVR</div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-name="REDIS">REDIS</div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-name="DB (M)">DB (M)</div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-name="DB (S)">DB (S)</div>
                </div>
                
                <div class="canvas-zone" id="canvas-zone" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <svg id="connection-layer"></svg>
                    <div style="position: absolute; top:40%; left:50%; transform:translate(-50%, -50%); color: rgba(255,255,255,0.1); pointer-events:none; text-align:center;">
                        DRAG & DROP HERE
                    </div>
                </div>
            </div>

            <div class="interrogation-panel" id="dialog-panel" onclick="handlePanelClick(event)">
                <div class="detective-face"><svg width="100%" height="100%"><use href="#duck-avatar"/></svg></div>
                <div class="dialog-container">
                    <div class="dialog-box" id="detective-msg"></div>
                    <div class="input-area hidden" id="deep-dive-input">
                        <input type="text" id="user-answer" class="pixel-input" placeholder="답변을 입력하세요..." onkeypress="if(event.key==='Enter') submitAnswer()">
                        <button class="btn" onclick="submitAnswer()">입력</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="scene-result" class="hidden">
        <div class="result-report">
            <div class="stamp-mark" id="final-stamp">GUILTY</div>
            <h1 style="text-align:center; border-bottom:2px solid black;">CASE CLOSED</h1>
            <p><strong>DATE:</strong> 2026-01-27</p>
            <p><strong>OFFICER:</strong> DET. DUCK</p>
            <hr>
            <h3>[ REPORT ]</h3>
            <p>> Architecture: <span style="color:red">INCOMPLETE</span></p>
            <p>> Defense Logic: <span style="color:orange">WEAK</span></p>
            <br>
            <p style="background: black; color: white; padding: 10px;">
                "설계도가 엉망이군. 다시 공부하고 돌아와라. 꽥!"
            </p>
            <br>
            <div style="text-align:center;">
                <button class="btn" onclick="location.reload()">재수사 요청 (RETRY)</button>
            </div>
        </div>
    </div>

</div>

<script>
    /* === INTRO LOGIC === */
    const introLines = [
        "거기 서! 도망갈 생각 마라. 꽥!",
        "네가 김개발인가? 오늘 발생한 대규모 서버 폭파 사건...",
        "가장 유력한 용의자로 지목되었다.",
        "억울하다고? 그렇다면 취조실로 들어와서 직접 증명해 봐.",
        "(철창 문이 열린다...)"
    ];
    let introIndex = 0;

    // 페이지 로드 시 첫 대사
    window.onload = () => {
        setTimeout(() => {
            document.getElementById('intro-duck').classList.add('appear');
            typeIntro(introLines[0]);
        }, 500);
    };

    function nextIntroLine() {
        if (introIsTyping) { // 타이핑 중 클릭하면 즉시 완성
            finishIntroTyping();
            return;
        }

        introIndex++;
        if (introIndex < introLines.length) {
            typeIntro(introLines[introIndex]);
        } else {
            // 인트로 끝 -> 버튼 등장
            document.getElementById('intro-box').classList.add('hidden');
            document.getElementById('start-btn').classList.remove('hidden');
        }
    }

    let introInterval;
    let introIsTyping = false;
    let currentIntroText = "";

    function typeIntro(text) {
        const el = document.getElementById('intro-text');
        el.innerText = "";
        currentIntroText = text;
        introIsTyping = true;
        let i = 0;
        
        clearInterval(introInterval);
        introInterval = setInterval(() => {
            if (i < text.length) {
                el.innerText += text.charAt(i);
                i++;
            } else {
                finishIntroTyping();
            }
        }, 30);
    }

    function finishIntroTyping() {
        clearInterval(introInterval);
        document.getElementById('intro-text').innerText = currentIntroText;
        introIsTyping = false;
    }

    function enterGame() {
        document.getElementById('scene-intro').classList.add('hidden');
        document.getElementById('scene-game').classList.remove('hidden');
        typeGameWriter("자, 여기에 앉아. 왼쪽 사건 파일을 보고 설계도를 완성해. (클릭하면 이 창이 내려갑니다)");
    }


    /* === MAIN GAME LOGIC === */
    let isConnectMode = false;
    let selectedComponent = null;
    let componentCount = 0;
    
    // 심문 질문들
    const questions = [
        "L7 로드밸런서를 썼군. 트래픽은 어떤 기준으로 나눌 셈이지?",
        "Redis 캐시가 죽으면 DB 부하가 급증할 텐데(Cache Stampede), 대비책은?",
        "좋아. 마지막으로 DB 동기화 지연(Lag) 문제는 어떻게 해결할 건가?"
    ];
    let qIndex = 0;
    let isDeepDive = false;

    function toggleConnectMode() {
        isConnectMode = !isConnectMode;
        const btn = document.getElementById('btn-connect');
        btn.classList.toggle('toggle-active');
        btn.innerText = isConnectMode ? "⚡ 연결 중..." : "⚡ 연결 모드";
        
        if(isConnectMode) {
            typeGameWriter("연결 모드다. 두 부품을 차례로 클릭해서 케이블을 연결해.");
            showPanel();
        } else {
            if(selectedComponent) selectedComponent.classList.remove('selected');
            selectedComponent = null;
        }
    }

    function startDeepDive() {
        isDeepDive = true;
        qIndex = 0;
        showPanel();
        document.getElementById('deep-dive-input').classList.remove('hidden');
        typeGameWriter(`[심문 시작] ${questions[0]}`);
    }

    function submitAnswer() {
        const input = document.getElementById('user-answer');
        if(!input.value.trim()) return alert("대답해라! 꽥!");
        
        input.value = "";
        qIndex++;
        if(qIndex < questions.length) {
            typeGameWriter(questions[qIndex]);
        } else {
            typeGameWriter("흐음... 기록했다. 최종 판결을 내리겠다...");
            document.getElementById('deep-dive-input').classList.add('hidden');
            setTimeout(showResult, 2000);
        }
    }

    function showResult() {
        document.getElementById('scene-game').classList.add('hidden');
        document.getElementById('scene-result').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('final-stamp').classList.add('stamped');
        }, 500);
    }

    function showHint() {
        showPanel();
        typeGameWriter("변호사(AI): 'L7 로드밸런서가 없으면 트래픽 분산이 안 됩니다!'");
    }

    /* === UTILS (Drag, Drop, Connect, Typewriter) === */
    function handlePanelClick(e) {
        if(e.target.closest('#deep-dive-input')) return;
        if(isDeepDive) return;
        
        const panel = document.getElementById('dialog-panel');
        panel.classList.toggle('panel-minimized');
    }
    function showPanel() { document.getElementById('dialog-panel').classList.remove('panel-minimized'); }

    function drag(ev) { ev.dataTransfer.setData("text", ev.target.getAttribute('data-name')); }
    function allowDrop(ev) { ev.preventDefault(); }
    function drop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const rect = document.getElementById('canvas-zone').getBoundingClientRect();
        const el = document.createElement("div");
        el.className = "placed-component";
        el.id = "comp-" + componentCount++;
        el.innerText = data;
        el.style.left = (ev.clientX - rect.left - 30) + "px";
        el.style.top = (ev.clientY - rect.top - 15) + "px";
        
        el.onclick = function(e) { 
            e.stopPropagation();
            if(isConnectMode) handleConnection(this);
        };
        document.getElementById('canvas-zone').appendChild(el);
    }

    function handleConnection(el) {
        if(!selectedComponent) {
            selectedComponent = el;
            el.classList.add('selected');
        } else {
            if(selectedComponent !== el) drawLine(selectedComponent, el);
            selectedComponent.classList.remove('selected');
            selectedComponent = null;
        }
    }

    function drawLine(el1, el2) {
        const svg = document.getElementById('connection-layer');
        const rect1 = el1.getBoundingClientRect();
        const rect2 = el2.getBoundingClientRect();
        const cRect = document.getElementById('canvas-zone').getBoundingClientRect();
        
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', rect1.left + rect1.width/2 - cRect.left);
        line.setAttribute('y1', rect1.top + rect1.height/2 - cRect.top);
        line.setAttribute('x2', rect2.left + rect2.width/2 - cRect.left);
        line.setAttribute('y2', rect2.top + rect2.height/2 - cRect.top);
        line.setAttribute('class', 'connection-line');
        svg.appendChild(line);
    }

    let gameTypeInterval;
    function typeGameWriter(text) {
        const el = document.getElementById('detective-msg');
        el.innerText = "";
        let i = 0;
        clearInterval(gameTypeInterval);
        gameTypeInterval = setInterval(() => {
            if(i < text.length) { el.innerText += text.charAt(i); i++; }
            else { clearInterval(gameTypeInterval); }
        }, 30);
    }
</script>

</body>
</html>