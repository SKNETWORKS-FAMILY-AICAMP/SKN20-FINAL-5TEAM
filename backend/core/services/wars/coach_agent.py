"""
coach_agent.py â€” CoachAgent
í”Œë ˆì´ì–´ì˜ ì„¤ê³„ ì •ì²´ë¥¼ ê°ì§€í•˜ê³  ë§¥ë½ì— ë§ëŠ” íŒíŠ¸ë¥¼ ìƒì„±í•œë‹¤.

[ê¸°ì¡´ ë°©ì‹ â€” ì—†ìŒ]
    ì •ì²´ ê°ì§€ ë¡œì§ ìì²´ê°€ ì—†ì—ˆìŒ.

[ì—ì´ì „íŠ¸ ë°©ì‹]
    state = draw_room_states[room_id]
    hint = CoachAgent().generate(state, sid)   # í”Œë ˆì´ì–´ë³„ ë§¥ë½ íŒíŠ¸
    await sio.emit('coach_hint', hint, to=sid) # ë³¸ì¸ì—ê²Œë§Œ ì „ì†¡

LLM ì—†ìŒ. ìˆœìˆ˜ ë£° ê¸°ë°˜ìœ¼ë¡œ ë™ì‘ (ì¸í„°ë·°ì˜ coach.py íŒ¨í„´ ë™ì¼í•˜ê²Œ ì ìš©).
ë¯¸ì…˜ required ì»´í¬ë„ŒíŠ¸ ëŒ€ë¹„ ëˆ„ë½ëœ ì»´í¬ë„ŒíŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ íŒíŠ¸ ìƒì„±.
"""

import logging
from typing import Dict, Any, Optional

logger = logging.getLogger(__name__)

# ì»´í¬ë„ŒíŠ¸ë³„ ì—­í•  ì„¤ëª… (íŒíŠ¸ ë©”ì‹œì§€ ìƒì„±ìš©)
COMPONENT_HINTS = {
    "client":   "ì‚¬ìš©ì ë‹¨ë§(Client)ì´ ì—†ìœ¼ë©´ íŠ¸ë˜í”½ ì§„ì…ì ì´ ë¶ˆëª…í™•í•©ë‹ˆë‹¤.",
    "lb":       "ë¡œë“œë°¸ëŸ°ì„œ(LB)ëŠ” íŠ¸ë˜í”½ì„ ì—¬ëŸ¬ ì„œë²„ì— ë¶„ì‚°ì‹œì¼œ ë‹¨ì¼ ì¥ì• ì ì„ ì œê±°í•©ë‹ˆë‹¤.",
    "server":   "ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•  ì„œë²„(WAS/EC2)ë¥¼ ë°°ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.",
    "cdn":      "ì •ì  ë¦¬ì†ŒìŠ¤ë¥¼ CDNìœ¼ë¡œ ë¶„ì‚°í•˜ë©´ ì‘ë‹µ ì†ë„ì™€ ì„œë²„ ë¶€í•˜ë¥¼ í¬ê²Œ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "cache":    "Redis ê°™ì€ ìºì‹œ ë ˆì´ì–´ë¥¼ ì¶”ê°€í•˜ë©´ DB ë¶€í•˜ë¥¼ ì¤„ì´ê³  ì‘ë‹µ ì†ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "db":       "ë°ì´í„°ë¥¼ ì˜ì†ì ìœ¼ë¡œ ì €ì¥í•  DBê°€ ì—†ìœ¼ë©´ ì„¤ê³„ê°€ ì™„ì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
    "readdb":   "ì½ê¸° ì „ìš© ë³µì œë³¸(Read Replica)ì„ ì¶”ê°€í•˜ë©´ ì¡°íšŒ ì„±ëŠ¥ì„ ìˆ˜í‰ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "writedb":  "ì“°ê¸° ì „ìš© ë§ˆìŠ¤í„° DBë¥¼ ë¶„ë¦¬í•˜ë©´ ì½ê¸°/ì“°ê¸° ë¶€í•˜ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "api":      "API GatewayëŠ” ì¸ì¦, ë¼ìš°íŒ…, ì†ë„ ì œí•œì„ ì¤‘ì•™ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ì§„ì…ì ì…ë‹ˆë‹¤.",
    "auth":     "ì¸ì¦(Auth) ì„œë¹„ìŠ¤ê°€ ì—†ìœ¼ë©´ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "queue":    "ë©”ì‹œì§€ í(Queue)ëŠ” ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ë¥¼ ë‚®ì¶¥ë‹ˆë‹¤.",
    "waf":      "WAFëŠ” DDoS, SQL Injection ë“± ì™¸ë¶€ ê³µê²©ìœ¼ë¡œë¶€í„° ì‹œìŠ¤í…œì„ ë³´í˜¸í•©ë‹ˆë‹¤.",
    "dns":      "DNS ì„¤ì •ì´ ì—†ìœ¼ë©´ ì™¸ë¶€ íŠ¸ë˜í”½ ìœ ì… ê²½ë¡œê°€ ë¶ˆëª…í™•í•©ë‹ˆë‹¤.",
    "origin":   "On-Premise ì›ë³¸ ì„œë²„(Origin)ì™€ì˜ ì—°ê²°ì„ ì„¤ê³„ì— í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.",
    "payment":  "ê²°ì œ(Payment) ì„œë¹„ìŠ¤ëŠ” íŠ¸ëœì­ì…˜ ì›ìì„±ê³¼ ë³´ì•ˆì„ ë³„ë„ë¡œ ì„¤ê³„í•´ì•¼ í•©ë‹ˆë‹¤.",
    "order":    "ì£¼ë¬¸(Order) ì„œë¹„ìŠ¤ëŠ” ì¬ê³  ì‹œìŠ¤í…œê³¼ì˜ ì •í•©ì„±ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.",
}

# ë…¸ë“œ ìˆ˜ ê¸°ë°˜ ë‹¨ê³„ë³„ ì¼ë°˜ íŒíŠ¸
GENERAL_HINTS = [
    "ì•„ì§ ì•„ë¬´ê²ƒë„ ë°°ì¹˜í•˜ì§€ ì•Šìœ¼ì…¨ë„¤ìš”. ì‚¬ìš©ì(Client)ë¶€í„° ì‹œì‘í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?",
    "íŠ¸ë˜í”½ì´ ì–´ë””ì„œ ë“¤ì–´ì™€ì„œ ì–´ë””ë¡œ ê°€ëŠ”ì§€ íë¦„ì„ ë¨¼ì € ê·¸ë ¤ë³´ì„¸ìš”.",
    "í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ë¥¼ ëª¨ë‘ ë°°ì¹˜í•œ ë’¤, í™”ì‚´í‘œë¡œ ë°ì´í„° íë¦„ì„ ì—°ê²°í•´ë³´ì„¸ìš”.",
    "ë°°ì¹˜ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•©ë‹ˆë‹¤. ì»´í¬ë„ŒíŠ¸ ê°„ ì—°ê²°(í™”ì‚´í‘œ)ì´ ì„¤ê³„ì˜ í•µì‹¬ì…ë‹ˆë‹¤.",
]


class CoachAgent:
    """
    í”Œë ˆì´ì–´ ì„¤ê³„ í˜„í™©ì„ ë¶„ì„í•˜ì—¬ ë§¥ë½ì— ë§ëŠ” íŒíŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì—ì´ì „íŠ¸.
    LLM ì—†ìŒ â€” ì¸í„°ë·° coach.pyì™€ ë™ì¼í•œ ìˆœìˆ˜ ë£° ê¸°ë°˜ íŒ¨í„´.

    ì—­í• :
        - StateMachineì´ can_trigger_coach() ì¡°ê±´ ê²€ì‚¬
        - CoachAgentê°€ ëˆ„ë½ ì»´í¬ë„ŒíŠ¸ ë¶„ì„ â†’ íŒíŠ¸ ë©”ì‹œì§€ ìƒì„±
        - socket_serverê°€ í•´ë‹¹ í”Œë ˆì´ì–´ì—ê²Œë§Œ emit
    """

    def generate(
        self,
        mission_required: list,
        deployed_nodes: list,
        arrow_count: int = 0,
        node_count: int = 0,
    ) -> Dict[str, Any]:
        """
        í”Œë ˆì´ì–´ ì„¤ê³„ í˜„í™©ì„ ë¶„ì„í•˜ì—¬ íŒíŠ¸ë¥¼ ìƒì„±í•œë‹¤.

        Args:
            mission_required: ì´ë²ˆ ë¯¸ì…˜ì˜ í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ ID ëª©ë¡ (ì˜ˆ: ["lb", "server", "db"])
            deployed_nodes: í”Œë ˆì´ì–´ê°€ í˜„ì¬ ë°°ì¹˜í•œ ì»´í¬ë„ŒíŠ¸ ID ëª©ë¡
            arrow_count: í˜„ì¬ ì—°ê²°ëœ í™”ì‚´í‘œ ìˆ˜
            node_count: í˜„ì¬ ë°°ì¹˜ëœ ë…¸ë“œ ìˆ˜ (deployed_nodesì™€ ì¼ì¹˜)

        Returns:
            {
                "message": "íŒíŠ¸ ë©”ì‹œì§€",
                "missing_components": ["ëˆ„ë½ëœ ì»´í¬ë„ŒíŠ¸ ëª©ë¡"],
                "type": "missing_component" | "no_arrows" | "general"
            }
        """
        deployed_set = set(deployed_nodes)
        required_set = set(mission_required)
        missing = list(required_set - deployed_set)

        # ì¼€ì´ìŠ¤ 1: ì•„ì§ ì•„ë¬´ê²ƒë„ ë°°ì¹˜ ì•ˆ í•¨
        if node_count == 0:
            return {
                "message": GENERAL_HINTS[0],
                "missing_components": list(required_set),
                "type": "general",
            }

        # ì¼€ì´ìŠ¤ 2: í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ ëˆ„ë½ â†’ ê°€ì¥ ì¤‘ìš”í•œ ëˆ„ë½ ì»´í¬ë„ŒíŠ¸ 1ê°œ íŒíŠ¸
        if missing:
            # ìš°ì„ ìˆœìœ„: required ìˆœì„œ ê¸°ì¤€ ì²« ë²ˆì§¸ ëˆ„ë½
            priority_missing = missing[0]
            for req in mission_required:
                if req in missing:
                    priority_missing = req
                    break

            hint_msg = COMPONENT_HINTS.get(
                priority_missing,
                f"'{priority_missing}' ì»´í¬ë„ŒíŠ¸ë¥¼ ì„¤ê³„ì— ì¶”ê°€í•´ë³´ì„¸ìš”."
            )

            return {
                "message": f"ğŸ’¡ {hint_msg}",
                "missing_components": missing,
                "type": "missing_component",
            }

        # ì¼€ì´ìŠ¤ 3: í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ëŠ” ë‹¤ ìˆëŠ”ë° í™”ì‚´í‘œê°€ ì—†ìŒ
        if arrow_count == 0 and node_count >= 2:
            return {
                "message": "ğŸ’¡ ì»´í¬ë„ŒíŠ¸ë¥¼ ëª¨ë‘ ë°°ì¹˜í–ˆë„¤ìš”! ì´ì œ ë°ì´í„° íë¦„(í™”ì‚´í‘œ)ì„ ì—°ê²°í•´ë³´ì„¸ìš”.",
                "missing_components": [],
                "type": "no_arrows",
            }

        # ì¼€ì´ìŠ¤ 4: ëª¨ë‘ ì™„ë£Œ â†’ íŒíŠ¸ ë¶ˆí•„ìš”
        logger.info("[CoachAgent] ëª¨ë“  í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ ë°°ì¹˜ ì™„ë£Œ, íŒíŠ¸ ë¶ˆí•„ìš”")
        return {
            "message": "",
            "missing_components": [],
            "type": "complete",
        }
