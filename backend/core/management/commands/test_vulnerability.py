from django.core.management.base import BaseCommand
from django.contrib.auth import get_user_model
from core.services.vulnerability_service import VulnerabilityAnalysisService
import json

class Command(BaseCommand):
    help = 'Tests the Vulnerability Analysis Service'

    def handle(self, *args, **options):
        User = get_user_model()
        # Get the first user
        user = User.objects.first()
        
        if not user:
            self.stdout.write(self.style.ERROR("No users found in the database."))
            return

        self.stdout.write(self.style.SUCCESS(f"Testing Vulnerability Analysis for user: {user.email} (ID: {user.id})"))

        service = VulnerabilityAnalysisService()
        try:
            result = service.analyze_vulnerabilities(user.id)
            self.stdout.write("\n=== Analysis Result ===")
            self.stdout.write(json.dumps(result, indent=2, ensure_ascii=False))
            
            if "error" in result:
                self.stdout.write(self.style.ERROR("\n[FAIL] Analysis returned an error."))
            else:
                self.stdout.write(self.style.SUCCESS("\n[SUCCESS] Analysis completed successfully."))
                
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"\n[ERROR] Exception occurred: {e}"))
